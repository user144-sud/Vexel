<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ActorScript v5.24 - Balde de Tinta</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'VT323', monospace; padding: 10px; background-color: #f0f2f5; font-size: 20px; user-select: none; padding-top: 70px; }
        #main-container { display: flex; justify-content: space-between; }
        .column { display: flex; flex-direction: column; gap: 15px; padding: 15px; background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #block-palette { width: 25%; }
        #scripting-area { width: 45%; }
        #stage-area { width: 30%; }
        h3 { margin-top: 0; border-bottom: 2px solid #e0e0e0; padding-bottom: 8px; color: #333; font-size: 24px; }
        .block-category { margin-bottom: 10px; }
        .block { padding: 10px; margin-bottom: 8px; border-radius: 5px; color: white; cursor: pointer; text-align: center; display: flex; align-items: center; justify-content: center; gap: 5px; flex-wrap: wrap; }
        .block-motion { background-color: #4C97FF; }
        .block-event { background-color: #FFC300; }
        .block-control { background-color: #FFAB19; }
        .block-variable { background-color: #FF8C1A; }
        .block-custom { background-color: #FF6680; }
        
        #script-container { min-height: 500px; border: 1px dashed #ccc; padding: 10px; border-radius: 4px; }
        .script-wrapper { margin-bottom: 20px; border-left: 3px solid transparent; padding-left: 5px; }
        .script-wrapper.active { border-left: 3px solid #FF6680; }
        .hat-block { border-radius: 15px 15px 3px 3px; }
        .script-block { padding: 8px 12px; color: white; display: flex; align-items: center; flex-wrap: wrap; gap: 8px; margin-bottom: -1px; border-radius: 0 0 3px 3px; }
        .script-wrapper > .script-block { cursor: pointer; }
        .script-block.hat-block { cursor: default; }
        .script-block input, .script-block select { width: 80px; padding: 5px; border: none; border-radius: 5px; font-family: 'VT323', monospace; font-size: 20px; text-align: center; cursor: pointer; }
        .script-block select { width: auto; min-width: 100px; text-align-last: center; }
        
        .variable-pill-container { display: flex; flex-direction: column; gap: 5px; margin-top: 10px; }
        .variable-pill { background-color: #FF8C1A; color: white; padding: 2px 10px; border-radius: 10px; font-size: 18px; border: 1px solid white; }
        .variable-pill.param { background-color: #FF6680; }
        .variable-pill-in-block { background-color: #FF8C1A; color: white; padding: 2px 10px; border-radius: 10px; font-size: 18px; border: 1px solid rgba(255,255,255,0.5); cursor: pointer; }
        .variable-pill-in-block.param { background-color: #FF6680; }
        .variable-control { display: flex; align-items: center; gap: 5px; }
        
        #param-menu { position: absolute; background-color: #fff; border: 1px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border-radius: 4px; padding: 5px; z-index: 1000; }
        #param-menu ul { list-style: none; margin: 0; padding: 0; }
        #param-menu li { padding: 5px 10px; cursor: pointer; }
        #param-menu li:hover { background-color: #f0f0f0; }

        #stage { width: 100%; height: 400px; border: 2px solid #333; background-color: #f7f7f7; position: relative; overflow: hidden; cursor: crosshair; background-size: cover; image-rendering: pixelated; }
        #variable-display-container { position: absolute; top: 5px; left: 5px; display: flex; flex-direction: column; gap: 5px; z-index: 10; }
        .variable-display { background-color: #FF8C1A; color: white; padding: 2px 8px; border-radius: 4px; font-size: 18px; border: 1px solid white; }
        .actor { width: 40px; height: 40px; position: absolute; box-sizing: border-box; cursor: pointer; background-size: cover; image-rendering: pixelated; transform-origin: center center; }
        
        #controls button { width: 100%; padding: 10px 15px; border: none; color: white; font-size: 18px; cursor: pointer; border-radius: 5px; font-family: 'VT323', monospace; margin-bottom: 5px; }
        #btn-run { background-color: #28a745; } #btn-run.stop { background-color: #dc3545; } #btn-actor { background-color: #007bff; } #btn-draw-actor { background-color: #17a2b8; } #btn-edit-scenery { background-color: #20c997; } #btn-custom-block { background-color: #FF6680; } #btn-variable { background-color: #FF8C1A; }
        #actor-list { list-style: none; padding: 0; }
        #actor-list li.selected { background-color: #007bff; color: white; font-weight: bold; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: auto; max-height: 90vh; overflow-y: auto; }
        #custom-block-preview { background: #FF6680; padding: 10px; border-radius: 5px; min-height: 40px; margin: 10px 0; display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
        #custom-block-preview .param-pill { background: white; color: #FF6680; border-radius: 10px; padding: 2px 8px; }

        #header { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 10px 20px; background-color: #333; color: white; position: fixed; top: 0; left: 0; z-index: 1001; box-sizing: border-box; }
        #header h1 { margin: 0; font-size: 24px; }
        #header-buttons, #user-area { display: flex; align-items: center; gap: 15px; }
        #user-display { font-size: 18px; }
        #header button { padding: 5px 10px; font-size: 16px; background-color: #007bff; border: none; color: white; border-radius: 5px; cursor: pointer; font-family: 'VT323', monospace; }
        #header button.community-btn { background-color: #17a2b8; }
        .modal-content .form-group { margin-bottom: 15px; }
        .modal-content label { display: block; margin-bottom: 5px; color: #333; }
        .modal-content input[type="text"], .modal-content input[type="password"] { width: 100%; padding: 8px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; font-family: 'VT323', monospace; font-size: 18px; }
        .modal-content button { padding: 10px 15px; border: none; color: white; font-size: 18px; cursor: pointer; border-radius: 5px; font-family: 'VT323', monospace; margin-right: 10px; background-color: #28a745;}
        .modal-content button.cancel-btn { background-color: #6c757d; }
        .modal-content button.danger-btn { background-color: #dc3545; }
        
        #community-games-list { list-style: none; padding: 0; }
        #community-games-list li { background: #f0f2f5; padding: 10px; border-radius: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        #community-games-list button { font-size: 16px; background-color: #FF8C1A; }

        #play-mode-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        #play-mode-overlay #stage { width: 90vw; height: 70vh; max-width: 1000px; max-height: 750px; border: 3px solid #FF8C1A; }
        #play-mode-exit-btn { margin-top: 20px; padding: 10px 25px; font-size: 22px; background-color: #dc3545; border: none; color: white; border-radius: 5px; cursor: pointer; font-family: 'VT323', monospace; }
        
        .security-warning { color: #dc3545; font-weight: bold; text-align: center; border: 1px solid #dc3545; padding: 8px; border-radius: 4px; margin-bottom: 15px; font-size: 16px; }
        .account-tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid #ccc; }
        .account-tabs button { flex: 1; background: #eee; border: none; padding: 10px; font-size: 18px; cursor: pointer; border-radius: 5px 5px 0 0; }
        .account-tabs button.active { background: white; border: 1px solid #ccc; border-bottom: 1px solid white; margin-bottom: -1px; }
        .account-tab-content { display: none; }
        .account-tab-content.active { display: block; }

        /* Pixel Editor Styles */
        #pixel-editor-container, #scenery-editor-container { display: flex; gap: 20px; align-items: flex-start; }
        #pixel-grid { display: grid; grid-template-columns: repeat(16, 25px); grid-template-rows: repeat(16, 25px); border: 1px solid #999; width: 400px; height: 400px; cursor: crosshair; }
        #scenery-grid { display: grid; grid-template-columns: repeat(32, 15px); grid-template-rows: repeat(24, 15px); border: 1px solid #999; width: 480px; height: 360px; cursor: crosshair; }
        .pixel, .scenery-pixel { background-color: transparent; box-sizing: border-box; }
        .pixel { width: 25px; height: 25px; border: 1px solid #eee; transition: transform 0.1s ease-out; }
        .scenery-pixel { width: 15px; height: 15px; border: 1px solid #f9f9f9; }
        .pixel.pop { animation: pop 0.2s ease-out; }
        @keyframes pop { 0% { transform: scale(0.8); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        #pixel-controls { display: flex; flex-direction: column; gap: 15px; }
        #scenery-tools { display: flex; gap: 10px; }
        #pixel-preview-container { text-align: center; }
        #pixel-preview-canvas { width: 160px; height: 160px; border: 2px solid #333; image-rendering: pixelated; background-color: #f0f2f5; }
        #color-palette { display: grid; grid-template-columns: repeat(5, 35px); gap: 5px; }
        .color-box { width: 35px; height: 35px; border: 2px solid #ccc; cursor: pointer; border-radius: 4px; }
        .color-box.active { border-color: #000; box-shadow: 0 0 5px rgba(0,0,0,0.5); transform: scale(1.1); }
        .eraser { background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); background-size: 10px 10px; background-position: 0 0, 0 5px, 5px -5px, -5px 0px; }
    </style>
</head>
<body>

    <div id="header">
        <h1>ActorScript v5.24 - Balde de Tinta</h1>
        <div id="header-buttons">
            <button class="community-btn" onclick="openPublishModal()">Publicar Jogo</button>
            <button class="community-btn" onclick="openCommunityModal()">Jogos da Comunidade</button>
        </div>
        <div id="user-area">
            <span id="user-display">Usuário: Convidado</span>
            <button id="btn-account" onclick="openAccountModal()">Conta</button>
        </div>
    </div>

    <main id="main-container">
        <div class="column" id="block-palette">
            <div class="block-category">
                <h3>Movimento</h3>
                <div class="block block-motion" onclick="addBlockToScript('GOTO_XY')">Vá para X: 0 Y: 0</div>
                <div class="block block-motion" onclick="addBlockToScript('SET_X')">Vá para X: 0</div>
                <div class="block block-motion" onclick="addBlockToScript('SET_Y')">Vá para Y: 0</div>
                <div class="block block-motion" onclick="addBlockToScript('GOTO_RANDOM')">Vá para (posição aleatória)</div>
                <div class="block block-motion" onclick="addBlockToScript('SET_SIZE')">definir tamanho para 100 %</div>
                <div class="block block-motion" onclick="addBlockToScript('MOVE_STEPS')">Mova 10 passos</div>
                <div class="block block-motion" onclick="addBlockToScript('POINT_IN_DIRECTION')">Aponte para a direção 90</div>
                <div class="block block-motion" onclick="addBlockToScript('TURN_DEGREES')">Gire 15 graus</div>
            </div>
            <div class="block-category"><h3>Eventos</h3><div class="block block-event" onclick="createNewScript('ON_START')">Quando o jogo começar</div><div class="block block-event" onclick="createNewScript('ON_CLICK')">Quando este ator for clicado</div><div class="block block-event" onclick="createNewScript('ON_KEY')">Quando a tecla [ w ] for pressionada</div><div class="block block-event" onclick="addBlockToScript('BROADCAST')">Mande a mensagem [ nome ]</div><div class="block block-event" onclick="createNewScript('ON_MESSAGE')">Quando eu receber [ nome ]</div></div>
            <div class="block-category"><h3>Controle</h3><div class="block block-control" onclick="createNewScript('FOREVER')">Para sempre</div><div class="block block-control" onclick="addBlockToScript('WAIT_SECONDS')">Espere 1 segundos</div><div class="block block-control" onclick="addBlockToScript('IF_COLLISION')">Se colidir com ...</div><div class="block block-control" onclick="addBlockToScript('STOP')">Pare ...</div></div>
            <div class="block-category" id="variable-blocks-palette"><h3>Variáveis</h3><button id="btn-variable" onclick="createVariable()">Criar uma Variável</button><div class="variable-pill-container" id="variable-pills"></div></div>
            <div class="block-category" id="custom-blocks-palette"><h3>Meus Blocos</h3><button id="btn-custom-block" onclick="openCustomBlockModal()">Criar um Bloco</button></div>
        </div>

        <div class="column" id="scripting-area"> <h3 id="script-title">Script (Nenhum Ator)</h3> <div id="script-container" onclick="setActiveScript(event)"></div> </div>
        <div class="column" id="stage-area"> <h3>Palco</h3> <div id="stage"><div id="variable-display-container"></div></div> <div id="controls"> <button id="btn-run" onclick="toggleExecution()">Executar</button> <hr> <h3>Atores</h3> <ul id="actor-list"></ul> <button id="btn-actor" onclick="createActor()">Criar Novo Ator</button> <button id="btn-draw-actor" onclick="openPixelEditor()">Desenhar Ator</button> <hr> <button id="btn-edit-scenery" onclick="openSceneryEditor()">Editar Cenário</button> </div> </div>
    </main>
    
    <div id="custom-block-modal" class="modal-overlay"> <div class="modal-content"><h4>Crie seu Bloco</h4><div id="custom-block-preview"></div><div><button onclick="addLabelToCustomBlock()">Adicionar Texto</button><button onclick="addParamToCustomBlock()">Adicionar Parâmetro (bola)</button></div><hr><button onclick="saveCustomBlock()">Salvar</button><button class="cancel-btn" onclick="closeCustomBlockModal()">Cancelar</button></div></div>
    <div id="param-menu" style="display: none;"></div>

    <div id="account-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="account-tabs">
                <button id="tab-login-btn" onclick="switchAccountTab('login')">Entrar</button>
                <button id="tab-register-btn" onclick="switchAccountTab('register')">Criar Conta</button>
            </div>
            
            <div id="login-tab" class="account-tab-content">
                <h4>Entrar na Conta</h4>
                <div class="form-group"> <label for="login-username">Nome de Usuário:</label> <input type="text" id="login-username"> </div>
                <div class="form-group"> <label for="login-password">Senha:</label> <input type="password" id="login-password"> </div>
                <hr> <button onclick="loginUser()">Entrar</button> <button class="cancel-btn" onclick="closeAccountModal()">Cancelar</button>
            </div>

            <div id="register-tab" class="account-tab-content">
                <h4>Criar Nova Conta</h4>
                 <p class="security-warning">AVISO: NÃO use senhas reais! Este site é um protótipo e não possui segurança. As informações são salvas localmente no seu navegador.</p>
                <div class="form-group"> <label for="register-username">Nome de Usuário:</label> <input type="text" id="register-username"> </div>
                <div class="form-group"> <label for="register-password">Senha:</label> <input type="password" id="register-password"> </div>
                <hr> <button onclick="registerUser()">Criar</button> <button class="cancel-btn" onclick="closeAccountModal()">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="publish-modal" class="modal-overlay">
        <div class="modal-content">
            <h4>Publicar Jogo na Comunidade</h4>
            <div class="form-group"> <label for="game-name">Nome do Jogo:</label> <input type="text" id="game-name"> </div>
            <div class="form-group"> <label for="creator-name">Seu Nome:</label> <input type="text" id="creator-name" readonly> </div>
            <hr> <button onclick="publishGame()">Publicar</button> <button class="cancel-btn" onclick="closePublishModal()">Cancelar</button>
        </div>
    </div>

    <div id="community-modal" class="modal-overlay">
        <div class="modal-content">
            <h4>Jogos da Comunidade</h4>
            <ul id="community-games-list"><li>Nenhum jogo publicado ainda.</li></ul>
            <hr> 
            <button class="danger-btn" onclick="resetCommunityGames()">Reiniciar Comunidade</button>
            <button class="cancel-btn" onclick="closeCommunityModal()">Voltar ao Editor</button>
        </div>
    </div>

    <div id="play-mode-overlay"></div>

    <div id="pixel-editor-modal" class="modal-overlay">
        <div class="modal-content">
            <h4>Editor de Pixel Art do Ator</h4>
            <div id="pixel-editor-container">
                <div id="pixel-grid"></div>
                <div id="pixel-controls">
                    <div id="pixel-preview-container">
                        <h5>Pré-visualização</h5>
                        <canvas id="pixel-preview-canvas" width="16" height="16"></canvas>
                    </div>
                    <hr>
                    <h5>Paleta</h5>
                    <div id="color-palette"></div>
                    <hr>
                    <button onclick="clearPixelGrid()">Limpar</button>
                    <button onclick="savePixelArt()">Salvar e Fechar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="scenery-editor-modal" class="modal-overlay">
        <div class="modal-content">
            <h4>Editor de Cenário</h4>
            <div id="scenery-editor-container">
                <div id="scenery-grid"></div>
                <div id="pixel-controls">
                    <h5>Paleta</h5>
                    <div id="scenery-color-palette"></div>
                    <hr>
                    <h5>Ferramentas</h5>
                    <div id="scenery-tools">
                        <button onclick="clearSceneryGrid()">Limpar</button>
                        <button onclick="fillSceneryGrid()" title="Preencher (Balde)">&#128396;</button>
                    </div>
                    <hr>
                    <button onclick="saveScenery()">Salvar e Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ESTADO GLOBAL ---
        let actors = []; let globalVariables = []; let customBlocks = [];
        let stageBackground = null;
        let selectedActorId = null; let activeScriptIndex = null;
        let isRunning = false; let animationFrameId = null;
        let executionStack = []; let newBlockDefinition = [];
        let activeInputContext = null;
        let currentUser = null;
        let originalStageParent = null; // Para o Modo Jogo
        const stage = document.getElementById('stage');
        const modal = document.getElementById('custom-block-modal');
        const paramMenu = document.getElementById('param-menu');
        const varDisplayContainer = document.getElementById('variable-display-container');
        const accountModal = document.getElementById('account-modal');
        const publishModal = document.getElementById('publish-modal');
        const communityModal = document.getElementById('community-modal');
        const userDisplay = document.getElementById('user-display');
        const createAccountBtn = document.getElementById('btn-account');
        
        // --- ESTADO DOS EDITORES ---
        const pixelEditorModal = document.getElementById('pixel-editor-modal');
        const pixelGrid = document.getElementById('pixel-grid');
        const colorPaletteContainer = document.getElementById('color-palette');
        const previewCanvas = document.getElementById('pixel-preview-canvas');
        const sceneryEditorModal = document.getElementById('scenery-editor-modal');
        const sceneryGrid = document.getElementById('scenery-grid');
        const sceneryColorPaletteContainer = document.getElementById('scenery-color-palette');
        const PIXEL_GRID_SIZE = 16;
        const SCENERY_GRID_WIDTH = 32;
        const SCENERY_GRID_HEIGHT = 24;
        let isDrawingPixels = false;
        let activeColor = '#FF8C1A';
        const paletteColors = [
            '#FF0000', '#FF8C1A', '#FFFF00', '#00FF00', '#0000FF', '#4B0082', '#9400D3', '#FFFFFF', '#000000', 'transparent'
        ];

        // --- LÓGICA DO MODO JOGO ---
        function enterPlayMode() {
            document.getElementById('header').style.display = 'none';
            document.getElementById('main-container').style.display = 'none';
            const overlay = document.getElementById('play-mode-overlay');
            overlay.style.display = 'flex';
            originalStageParent = stage.parentElement;
            overlay.appendChild(stage);
            const exitBtn = document.createElement('button');
            exitBtn.id = 'play-mode-exit-btn';
            exitBtn.textContent = 'Sair do Modo Jogo';
            exitBtn.onclick = exitPlayMode;
            overlay.appendChild(exitBtn);
            if (!isRunning) toggleExecution();
        }
        function exitPlayMode() {
            if (isRunning) toggleExecution();
            if (originalStageParent) {
                const controls = originalStageParent.querySelector('#controls');
                originalStageParent.insertBefore(stage, controls);
            }
            const overlay = document.getElementById('play-mode-overlay');
            if (overlay) {
                overlay.innerHTML = '';
                overlay.style.display = 'none';
            }
            document.getElementById('header').style.display = 'flex';
            document.getElementById('main-container').style.display = 'flex';
        }

        // --- LÓGICA DA COMUNIDADE ---
        function openPublishModal() { if (actors.length === 0) { alert("Você não pode publicar um projeto vazio!"); return; } if (!currentUser) { alert("Você precisa entrar em uma conta para publicar!"); return; } document.getElementById('game-name').value = ''; document.getElementById('creator-name').value = currentUser; publishModal.style.display = 'flex'; }
        function closePublishModal() { publishModal.style.display = 'none'; }
        function publishGame() {
            const gameName = document.getElementById('game-name').value.trim();
            const creatorName = document.getElementById('creator-name').value.trim();
            if (!gameName || !creatorName) { alert("Por favor, preencha todos os campos."); return; }
            const gameState = serializeGameState();
            const communityGames = JSON.parse(localStorage.getItem('communityGames') || '[]');
            communityGames.push({ id: Date.now(), name: gameName, creator: creatorName, data: gameState });
            localStorage.setItem('communityGames', JSON.stringify(communityGames));
            alert(`"${gameName}" foi publicado com sucesso!`);
            closePublishModal();
        }
        function openCommunityModal() {
            const list = document.getElementById('community-games-list');
            const communityGames = JSON.parse(localStorage.getItem('communityGames') || '[]');
            list.innerHTML = '';
            if (communityGames.length === 0) {
                list.innerHTML = '<li>Nenhum jogo publicado ainda.</li>';
            } else {
                communityGames.forEach((game, index) => {
                    const item = document.createElement('li');
                    item.innerHTML = `<span><strong>${game.name}</strong> por ${game.creator}</span>`;
                    const loadBtn = document.createElement('button');
                    loadBtn.textContent = 'Carregar e Jogar';
                    loadBtn.onclick = () => loadGame(index);
                    item.appendChild(loadBtn);
                    list.appendChild(item);
                });
            }
            communityModal.style.display = 'flex';
        }
        function closeCommunityModal() { communityModal.style.display = 'none'; }
        function loadGame(gameIndex) {
            if (!confirm("Isso irá substituir seu projeto atual. Deseja continuar?")) return;
            const communityGames = JSON.parse(localStorage.getItem('communityGames') || '[]');
            const game = communityGames[gameIndex];
            if (game && game.data) {
                deserializeAndLoadState(game.data);
                closeCommunityModal();
                enterPlayMode();
            } else { alert("Erro ao carregar o jogo."); }
        }
        function resetCommunityGames() {
            if (confirm("TEM CERTEZA?\nTodos os jogos publicados na comunidade (salvos neste navegador) serão apagados permanentemente. Esta ação não pode ser desfeita.")) {
                localStorage.removeItem('communityGames');
                alert("Os jogos da comunidade foram reiniciados.");
                openCommunityModal(); // Refresh the list
            }
        }
        function serializeGameState() {
             const state = { actors: [], globalVariables, customBlocks, stageBackground };
             state.actors = JSON.parse(JSON.stringify(actors, (key, value) => (key === 'element' ? undefined : value) ));
             return JSON.stringify(state);
        }
        function deserializeAndLoadState(jsonState) {
            const state = JSON.parse(jsonState);
            actors.forEach(a => a.element.remove());
            actors = []; globalVariables = []; customBlocks = []; selectedActorId = null; activeScriptIndex = null;
            globalVariables = state.globalVariables || [];
            customBlocks = state.customBlocks || [];
            stageBackground = state.stageBackground || createDefaultBackground();
            
            (state.actors || []).forEach(actorData => {
                 const newActor = { ...actorData, element: null };
                 const e = document.createElement('div');
                 e.className = 'actor'; e.id = `actor-${newActor.id}`;
                 stage.appendChild(e); newActor.element = e;
                 actors.push(newActor);
                 renderActorCostume(newActor);
                 updateActorPosition(newActor);
                 e.onclick = () => { if(isRunning) newActor.scripts.filter(s => s.trigger.type === 'ON_CLICK').forEach(s => executeScript(newActor, s)); };
            });
            if (actors.length > 0) selectActor(actors[0].id); else { updateActorList(); renderScriptForSelectedActor(); }
            renderCustomBlockPalette(); renderVariablePalette(); renderAllVariableDisplaysOnStage(); renderStageBackground();
        }

        // --- LÓGICA DA CONTA ---
        function openAccountModal() { 
            accountModal.style.display = 'flex';
            switchAccountTab('register'); 
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('register-username').value = '';
            document.getElementById('register-password').value = '';
        }
        function closeAccountModal() { accountModal.style.display = 'none'; }
        function switchAccountTab(tabName) {
            document.querySelectorAll('.account-tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.account-tabs button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.getElementById(`tab-${tabName}-btn`).classList.add('active');
        }
        function registerUser() {
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value.trim();
            if (!username || !password) { alert("Por favor, preencha todos os campos."); return; }
            const users = JSON.parse(localStorage.getItem('actorScriptUsers') || '[]');
            if (users.find(user => user.username === username)) { alert("Este nome de usuário já existe."); return; }
            users.push({ username, password });
            localStorage.setItem('actorScriptUsers', JSON.stringify(users));
            alert("Conta criada com sucesso! Agora você pode entrar.");
            switchAccountTab('login');
        }
        function loginUser() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();
            if (!username || !password) { alert("Por favor, preencha todos os campos."); return; }
            const users = JSON.parse(localStorage.getItem('actorScriptUsers') || '[]');
            const user = users.find(u => u.username === username && u.password === password);
            if (user) {
                currentUser = user.username;
                userDisplay.textContent = `Usuário: ${currentUser}`;
                createAccountBtn.textContent = 'Sair';
                createAccountBtn.onclick = logout;
                closeAccountModal();
            } else {
                alert("Nome de usuário ou senha incorretos.");
            }
        }
        function logout() {
            if (confirm("Tem certeza que deseja sair?")) {
                currentUser = null; userDisplay.textContent = 'Usuário: Convidado';
                createAccountBtn.textContent = 'Conta'; createAccountBtn.onclick = openAccountModal;
            }
        }

        // --- LÓGICA DO MODAL DE BLOCOS---
        function openCustomBlockModal() { if (!getSelectedActor()) { alert("Selecione um ator!"); return; } newBlockDefinition = []; document.getElementById('custom-block-preview').innerHTML = ''; modal.style.display = 'flex'; }
        function closeCustomBlockModal() { modal.style.display = 'none'; }
        function addLabelToCustomBlock() { const l = prompt("Texto do rótulo:"); if (l) { newBlockDefinition.push({ type: 'label', content: l }); renderModalPreview(); } }
        function addParamToCustomBlock() { const p = prompt("Nome do parâmetro:"); if (p && !newBlockDefinition.find(i => i.name === p)) { newBlockDefinition.push({ type: 'param', name: p }); renderModalPreview(); } else { alert("Nome inválido ou duplicado."); } }
        function renderModalPreview() { const p = document.getElementById('custom-block-preview'); p.innerHTML = ''; newBlockDefinition.forEach(part => { const e = document.createElement('span'); if (part.type === 'label') e.textContent = part.content; else { e.textContent = part.name; e.className = 'param-pill'; } p.appendChild(e); }); }
        function saveCustomBlock() { if (newBlockDefinition.length === 0) return; const id = `custom_${Date.now()}`; customBlocks.push({ id, definition: newBlockDefinition }); getSelectedActor().scripts.push({ trigger: { type: 'DEFINE', params: { blockId: id } }, blocks: [] }); renderCustomBlockPalette(); renderScriptForSelectedActor(); closeCustomBlockModal(); }

        // --- LÓGICA DE VARIÁVEIS ---
        function createVariable() {
            const varName = prompt("Nome da Variável:");
            if (varName && !globalVariables.find(v => v.name === varName)) {
                globalVariables.push({ name: varName, value: 0, displayOnStage: true });
                renderVariablePalette(); renderAllVariableDisplaysOnStage();
            } else { alert("Nome inválido ou já existente."); }
        }
        function renderVariablePalette() {
             const palette = document.getElementById('variable-blocks-palette'), pillContainer = document.getElementById('variable-pills');
             palette.querySelectorAll('.block.block-variable, .variable-control').forEach(b => b.remove());
             globalVariables.forEach(v => {
                 const setBlock = document.createElement('div'); setBlock.className = 'block block-variable'; setBlock.textContent = `Mudar [${v.name}] para [0]`; setBlock.onclick = () => addBlockToScript('SET_VAR', { varName: v.name }); palette.insertBefore(setBlock, pillContainer);
                 const changeBlock = document.createElement('div'); changeBlock.className = 'block block-variable'; changeBlock.textContent = `Adicione [1] a [${v.name}]`; changeBlock.onclick = () => addBlockToScript('CHANGE_VAR_BY', { varName: v.name }); palette.insertBefore(changeBlock, pillContainer);
                 const control = document.createElement('div'); control.className = 'variable-control';
                 const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.checked = v.displayOnStage; checkbox.onchange = () => toggleVariableDisplay(v.name);
                 const pill = document.createElement('div'); pill.className = 'variable-pill'; pill.textContent = v.name;
                 control.appendChild(checkbox); control.appendChild(pill);
                 pillContainer.appendChild(control);
             });
             if (activeScriptIndex !== null && getSelectedActor()) {
                 const script = getSelectedActor().scripts[activeScriptIndex];
                 if (script && script.trigger.type === 'DEFINE') {
                     const def = customBlocks.find(b => b.id === script.trigger.params.blockId);
                     if (def) def.definition.filter(p => p.type === 'param').forEach(p => { const pill = document.createElement('div'); pill.className = 'variable-pill param'; pill.textContent = p.name; pillContainer.appendChild(pill); });
                 }
             }
        }
        function toggleVariableDisplay(varName) { const v = globalVariables.find(i => i.name === varName); if (v) { v.displayOnStage = !v.displayOnStage; updateSingleVariableDisplay(v); } }
        function renderAllVariableDisplaysOnStage() { varDisplayContainer.innerHTML = ''; globalVariables.forEach(v => { const d = document.createElement('div'); d.id = `display-var-${v.name}`; d.className = 'variable-display'; d.style.display = v.displayOnStage ? 'block' : 'none'; d.textContent = `${v.name}: ${v.value}`; varDisplayContainer.appendChild(d); }); }
        function updateSingleVariableDisplay(variable) { const d = document.getElementById(`display-var-${variable.name}`); if (d) { d.style.display = variable.displayOnStage ? 'block' : 'none'; d.textContent = `${variable.name}: ${variable.value}`; } }
        function resolveParamValue(param, context) {
            if (!param) return 0;
            if (param.type === 'param' && context && context[param.content] !== undefined) return context[param.content];
            if (param.type === 'variable') return (globalVariables.find(v => v.name === param.content) || {}).value || 0;
            return param.content;
        }

        // --- LÓGICA DO MENU POPUP ---
        function showParamMenu(event, si, bi, pName) {
            event.stopPropagation(); activeInputContext = { scriptIndex: si, blockIndex: bi, paramName: pName }; paramMenu.innerHTML = '';
            const list = document.createElement('ul');
            globalVariables.forEach(v => { const i = document.createElement('li'); i.textContent = v.name; i.onclick = () => selectParam('variable', v.name); list.appendChild(i); });
            const s = getSelectedActor().scripts[si];
            if (s.trigger.type === 'DEFINE') {
                const def = customBlocks.find(b => b.id === s.trigger.params.blockId);
                if (def) { if (list.children.length > 0) list.appendChild(document.createElement('hr')); def.definition.filter(p => p.type === 'param').forEach(p => { const i = document.createElement('li'); i.textContent = p.name; i.onclick = () => selectParam('param', p.name); list.appendChild(i); }); }
            }
            if (list.children.length === 0) return;
            paramMenu.appendChild(list); const r = event.target.getBoundingClientRect(); paramMenu.style.left = `${r.left}px`; paramMenu.style.top = `${r.bottom + 2}px`; paramMenu.style.display = 'block';
        }
        function selectParam(type, content) { if (!activeInputContext) return; const { scriptIndex, blockIndex, paramName } = activeInputContext; getSelectedActor().scripts[scriptIndex].blocks[blockIndex].params[paramName] = { type, content }; hideParamMenu(); renderScriptForSelectedActor(); }
        function revertToValue(event, si, bi, pName) { event.stopPropagation(); getSelectedActor().scripts[si].blocks[bi].params[pName] = { type: 'value', content: 0 }; renderScriptForSelectedActor(); }
        function hideParamMenu() { paramMenu.style.display = 'none'; activeInputContext = null; }

        // --- LÓGICA DE CRIAÇÃO E DELEÇÃO DE BLOCOS ---
        function createNewScript(triggerType) { const a = getSelectedActor(); if (!a) { alert("Selecione um ator!"); return; } a.scripts.push({ trigger: { type: triggerType, params: {} }, blocks: [] }); renderScriptForSelectedActor(); }
        function addBlockToScript(blockType, options = {}) {
            const a = getSelectedActor(); if (!a) { alert("Selecione um ator!"); return; }
            if (a.scripts.length === 0) createNewScript('ON_START');
            const s = a.scripts[activeScriptIndex !== null ? activeScriptIndex : a.scripts.length - 1];
            if (!s) { alert("Selecione um script!"); return; }
            const d = { type: blockType, params: {} };
            if (blockType.startsWith('custom_')) { const def = customBlocks.find(b => b.id === blockType); def.definition.filter(p => p.type === 'param').forEach(p => { d.params[p.name] = { type: 'value', content: 0 }; }); }
            else if (blockType === 'GOTO_XY') { d.params.x = { type: 'value', content: 0 }; d.params.y = { type: 'value', content: 0 }; }
            else if (['SET_X', 'SET_Y'].includes(blockType)) { d.params.val = { type: 'value', content: 0 }; }
            else if (blockType === 'SET_SIZE') { d.params.val = { type: 'value', content: 100 }; }
            else if (['SET_VAR', 'CHANGE_VAR_BY'].includes(blockType)) { d.params.varName = options.varName; d.params.val = { type: 'value', content: (blockType === 'SET_VAR' ? 0 : 1) }; }
            else if (['BROADCAST', 'ON_MESSAGE'].includes(blockType)) { d.params.message = { content: 'nome' }; }
            else if (blockType === 'ON_KEY') { d.params.key = { content: 'w' }; }
            else if (blockType === 'MOVE_STEPS') { d.params.val = { type: 'value', content: 10 }; }
            else if (blockType === 'POINT_IN_DIRECTION') { d.params.val = { type: 'value', content: 90 }; }
            else if (blockType === 'TURN_DEGREES') { d.params.val = { type: 'value', content: 15 }; }
            else if (blockType === 'WAIT_SECONDS') { d.params.val = { type: 'value', content: 1 }; }
            else if (blockType === 'IF_COLLISION') { d.params.targetActorId = null; }
            else if (blockType === 'STOP') { d.params.target = 'all'; }
            s.blocks.push(d);
            renderScriptForSelectedActor();
        }
        function requestDeleteBlock(event, si, bi) { if (event.target.tagName.toLowerCase().match(/input|select/) || event.target.classList.contains('variable-pill-in-block')) return; if (confirm("Tem certeza?")) { getSelectedActor().scripts[si].blocks.splice(bi, 1); renderScriptForSelectedActor(); } }
        
        // --- LÓGICA DE RENDERIZAÇÃO ---
        function renderScriptForSelectedActor() { const a = getSelectedActor(), c = document.getElementById('script-container'); c.innerHTML = ''; if (!a) { document.getElementById('script-title').textContent = "Script (Nenhum Ator)"; return; } document.getElementById('script-title').textContent = `Script para: ${a.name}`; a.scripts.forEach((s, i) => { const w = document.createElement('div'); w.className = 'script-wrapper'; w.dataset.scriptIndex = i; if (i === activeScriptIndex) w.classList.add('active'); w.appendChild(renderBlock(a, s.trigger, i, -1, true)); s.blocks.forEach((b, bi) => w.appendChild(renderBlock(a, b, i, bi, false))); c.appendChild(w); }); }
        function renderBlock(actor, d, si, bi, isHat) {
             const div = document.createElement('div'); div.className = 'script-block'; if (!isHat) div.setAttribute('onclick', `requestDeleteBlock(event, ${si}, ${bi})`); else div.classList.add('hat-block');
             const renderParam = (p, pName) => { if (p && (p.type === 'variable' || p.type === 'param')) { return `<div class="variable-pill-in-block ${p.type}" onclick="event.stopPropagation(); revertToValue(event, ${si}, ${bi}, '${pName}')">${p.content}</div>`; } return `<input value="${(p||{}).content||0}" type="number" onclick="showParamMenu(event, ${si}, ${bi}, '${pName}')" onchange="updateParam(event, ${si}, ${bi}, '${pName}')">`; };
             const renderText = (p, pName) => `<input value="${(p||{}).content||''}" type="text" onchange="updateTextParam(${si}, ${bi}, '${pName}', this.value)">`;
             const renderActorDropdown = (selectedValue) => {
                 let options = actors.filter(a => a.id !== actor.id).map(a => `<option value="${a.id}" ${selectedValue === a.id ? 'selected' : ''}>${a.name}</option>`).join('');
                 return `<select onchange="updateCollisionTarget(${si}, ${bi}, this.value)">
                    <option value="">Selecione...</option>
                    ${options}
                 </select>`;
             };
             const renderStopDropdown = (selectedValue) => {
                 return `<select onchange="updateStopTarget(${si}, ${bi}, this.value)">
                    <option value="all" ${selectedValue === 'all' ? 'selected' : ''}>tudo</option>
                    <option value="this_actor" ${selectedValue === 'this_actor' ? 'selected' : ''}>este ator</option>
                 </select>`;
             };
             if (d.type.startsWith('custom_')) { div.classList.add('block-custom'); const def = customBlocks.find(b => b.id === d.type); if (def) def.definition.forEach(part => { div.innerHTML += (part.type === 'label') ? `<span>${part.content}</span>` : renderParam(d.params[part.name], part.name); }); }
             else if (d.type === 'DEFINE') { div.classList.add('block-custom', 'hat-block'); const def = customBlocks.find(b => b.id === d.params.blockId); let h = 'definir '; if (def) def.definition.forEach(part => { h += (part.type === 'label') ? `<span>${part.content}</span>` : `<div class="variable-pill param">${part.name}</div>`; }); div.innerHTML = h; }
             else { switch(d.type) {
                 case 'GOTO_XY': div.classList.add('block-motion'); div.innerHTML = `Vá para X: ${renderParam(d.params.x, 'x')} Y: ${renderParam(d.params.y, 'y')}`; break;
                 case 'SET_X': div.classList.add('block-motion'); div.innerHTML = `Vá para X: ${renderParam(d.params.val, 'val')}`; break;
                 case 'SET_Y': div.classList.add('block-motion'); div.innerHTML = `Vá para Y: ${renderParam(d.params.val, 'val')}`; break;
                 case 'GOTO_RANDOM': div.classList.add('block-motion'); div.innerHTML = 'Vá para (posição aleatória)'; break;
                 case 'SET_SIZE': div.classList.add('block-motion'); div.innerHTML = `definir tamanho para ${renderParam(d.params.val, 'val')} %`; break;
                 case 'MOVE_STEPS': div.classList.add('block-motion'); div.innerHTML = `Mova ${renderParam(d.params.val, 'val')} passos`; break;
                 case 'POINT_IN_DIRECTION': div.classList.add('block-motion'); div.innerHTML = `Aponte para a direção ${renderParam(d.params.val, 'val')}`; break;
                 case 'TURN_DEGREES': div.classList.add('block-motion'); div.innerHTML = `Gire ${renderParam(d.params.val, 'val')} graus`; break;
                 case 'ON_START': div.classList.add('block-event'); div.innerHTML = `Quando o jogo começar`; break;
                 case 'ON_CLICK': div.classList.add('block-event'); div.innerHTML = `Quando este ator for clicado`; break;
                 case 'ON_KEY': div.classList.add('block-event'); div.innerHTML = `Quando a tecla [${renderText(d.params.key, 'key')}] for pressionada`; break;
                 case 'BROADCAST': div.classList.add('block-event'); div.innerHTML = `Mande a mensagem [${renderText(d.params.message, 'message')}]`; break;
                 case 'ON_MESSAGE': div.classList.add('block-event'); div.innerHTML = `Quando eu receber [${renderText(d.params.message, 'message')}]`; break;
                 case 'FOREVER': div.classList.add('block-control'); div.innerHTML = `Para sempre`; break;
                 case 'WAIT_SECONDS': div.classList.add('block-control'); div.innerHTML = `Espere ${renderParam(d.params.val, 'val')} segundos`; break;
                 case 'IF_COLLISION': div.classList.add('block-control'); div.innerHTML = `Se colidir com ${renderActorDropdown(d.params.targetActorId)}`; break;
                 case 'STOP': div.classList.add('block-control'); div.innerHTML = `Pare ${renderStopDropdown(d.params.target)}`; break;
                 case 'SET_VAR': div.classList.add('block-variable'); div.innerHTML = `Mudar [${d.params.varName}] para ${renderParam(d.params.val, 'val')}`; break;
                 case 'CHANGE_VAR_BY': div.classList.add('block-variable'); div.innerHTML = `Adicione ${renderParam(d.params.val, 'val')} a [${d.params.varName}]`; break;
             } }
             return div;
        }
        function updateParam(event, si, bi, pName) { const v = event.target.value; getSelectedActor().scripts[si].blocks[bi].params[pName] = { type: 'value', content: parseFloat(v) || 0 }; }
        function updateTextParam(si, bi, pName, val) { const a = getSelectedActor(); let t = (bi === -1) ? a.scripts[si].trigger : a.scripts[si].blocks[bi]; if (!t.params[pName]) t.params[pName] = {}; t.params[pName].content = val; }
        function updateCollisionTarget(si, bi, targetId) { getSelectedActor().scripts[si].blocks[bi].params.targetActorId = targetId ? parseInt(targetId, 10) : null; }
        function updateStopTarget(si, bi, target) { getSelectedActor().scripts[si].blocks[bi].params.target = target; }
        function renderCustomBlockPalette() { const p = document.getElementById('custom-blocks-palette'); p.querySelectorAll('.block.block-custom').forEach(b => b.remove()); customBlocks.forEach(cb => { const d = document.createElement('div'); d.className = 'block block-custom'; cb.definition.forEach(part => { d.innerHTML += (part.type === 'label') ? `<span>${part.content}</span>` : `<div class="variable-pill param" style="pointer-events:none; font-size:16px;">${part.name}</div>`; }); d.onclick = () => addBlockToScript(cb.id); p.appendChild(d); }); }
        function setActiveScript(event) { const w = event.target.closest('.script-wrapper'); document.querySelectorAll('.script-wrapper').forEach(wr => wr.classList.remove('active')); if (w) { activeScriptIndex = parseInt(w.dataset.scriptIndex, 10); w.classList.add('active'); } else { activeScriptIndex = null; } renderVariablePalette(); }
        
        // --- LÓGICA DE EXECUÇÃO ---
        async function executeScript(actor, script, context = {}) {
            if (actor.isStopped) return;
            executionStack.push(context);
            for (let i = 0; i < script.blocks.length; i++) {
                if (!isRunning || actor.isStopped) break;
                const block = script.blocks[i];
                const result = await processBlock(actor, block);
                if (block.type === 'IF_COLLISION' && result === false) {
                    i++; // Pula o próximo bloco se a condição for falsa
                }
            }
            executionStack.pop();
        }
        async function processBlock(actor, blockData) {
            const context = executionStack[executionStack.length - 1] || {};
            let shouldUpdatePosition = true;
            let result = null;
            if (blockData.type.startsWith('custom_')) {
                const def = customBlocks.find(b => b.id === blockData.type); const script = findDefinitionScript(blockData.type);
                if (script && def) { const newContext = {}; def.definition.filter(p => p.type === 'param').forEach(p => { newContext[p.name] = resolveParamValue(blockData.params[p.name], context); }); await executeScript(actor, script, newContext); }
            } else {
                switch (blockData.type) {
                    case 'GOTO_XY': actor.x = resolveParamValue(blockData.params.x, context); actor.y = resolveParamValue(blockData.params.y, context); break;
                    case 'SET_X': actor.x = resolveParamValue(blockData.params.val, context); break;
                    case 'SET_Y': actor.y = resolveParamValue(blockData.params.val, context); break;
                    case 'GOTO_RANDOM': const w = stage.clientWidth, h = stage.clientHeight; actor.x = (Math.random() * w) - (w / 2); actor.y = (Math.random() * h) - (h / 2); break;
                    case 'SET_SIZE': actor.size = resolveParamValue(blockData.params.val, context); break;
                    case 'POINT_IN_DIRECTION': actor.direction = resolveParamValue(blockData.params.val, context); break;
                    case 'TURN_DEGREES': actor.direction += resolveParamValue(blockData.params.val, context); break;
                    case 'MOVE_STEPS': const steps = resolveParamValue(blockData.params.val, context); const angle = (actor.direction - 90) * (Math.PI / 180); actor.x += steps * Math.cos(angle); actor.y += steps * Math.sin(angle); break;
                    case 'WAIT_SECONDS': shouldUpdatePosition = false; const seconds = resolveParamValue(blockData.params.val, context); await new Promise(res => setTimeout(res, seconds * 1000)); break;
                    case 'BROADCAST': shouldUpdatePosition = false; broadcastMessage((blockData.params.message || {}).content); break;
                    case 'SET_VAR': const v = globalVariables.find(va => va.name === blockData.params.varName); if (v) { v.value = resolveParamValue(blockData.params.val, context); updateSingleVariableDisplay(v); } break;
                    case 'CHANGE_VAR_BY': const cv = globalVariables.find(va => va.name === blockData.params.varName); if (cv) { cv.value += resolveParamValue(blockData.params.val, context); updateSingleVariableDisplay(cv); } break;
                    case 'IF_COLLISION':
                        shouldUpdatePosition = false;
                        const targetActor = actors.find(a => a.id === blockData.params.targetActorId);
                        if (targetActor) {
                            const r1 = actor.element.getBoundingClientRect();
                            const r2 = targetActor.element.getBoundingClientRect();
                            result = !(r2.left > r1.right || r2.right < r1.left || r2.top > r1.bottom || r2.bottom < r1.top);
                        } else { result = false; }
                        break;
                    case 'STOP':
                        shouldUpdatePosition = false;
                        if (blockData.params.target === 'all') {
                           if (isRunning) toggleExecution();
                        } else {
                           actor.isStopped = true;
                        }
                        break;
                }
            }
            if (shouldUpdatePosition) {
                updateActorPosition(actor);
                await new Promise(res => setTimeout(res, 20));
            }
            return result;
        }

        function findDefinitionScript(id) { for (const a of actors) { const s = a.scripts.find(sc => sc.trigger.type === 'DEFINE' && sc.trigger.params.blockId === id); if (s) return s; } return null; }
        function broadcastMessage(msg) { if(!msg || !isRunning) return; actors.forEach(a => { a.scripts.filter(s => s.trigger.type === 'ON_MESSAGE' && (s.trigger.params.message||{}).content === msg).forEach(s => executeScript(a, s)); }); }
        
        // --- LÓGICA DO ATOR (ATOR) ---
        function createActor() { const n=prompt("Nome:",`Ator${actors.length+1}`); if(!n)return; const id=Date.now(); const defaultCostumeData = Array(PIXEL_GRID_SIZE*PIXEL_GRID_SIZE).fill('transparent'); const a={id,name:n,x:0,y:0,direction:90, size: 100, costume:{type:'pixel',data:defaultCostumeData}, element:null,scripts:[], isStopped: false}; const e=document.createElement('div');e.className='actor';e.id=`actor-${id}`;e.onclick=()=>{ if(isRunning) a.scripts.filter(s=>s.trigger.type==='ON_CLICK').forEach(s=>executeScript(a,s))};stage.appendChild(e);a.element=e;actors.push(a);renderActorCostume(a);updateActorPosition(a);updateActorList();selectActor(id); }
        function selectActor(id) { selectedActorId=id; activeScriptIndex=null; updateActorList(); renderScriptForSelectedActor(); renderVariablePalette(); }
        function getSelectedActor() { return actors.find(a => a.id === selectedActorId) || null; }
        function updateActorList() { const l=document.getElementById('actor-list');l.innerHTML='';actors.forEach(a=>{const i=document.createElement('li');i.textContent=a.name;i.className=(a.id===selectedActorId)?'selected':'';i.onclick=()=>selectActor(a.id);l.appendChild(i);}); }
        function updateActorPosition(actor) { const sw=stage.clientWidth,sh=stage.clientHeight; const s=40; const cx=actor.x+(sw/2),cy=-actor.y+(sh/2); actor.element.style.left=`${cx-(s/2)}px`;actor.element.style.top=`${cy-(s/2)}px`; const scale = (actor.size || 100) / 100; actor.element.style.transform = `rotate(${actor.direction - 90}deg) scale(${scale})`;}
        function renderActorCostume(actor) { if (!actor.costume || actor.costume.type !== 'pixel') return; const canvas = document.createElement('canvas'); canvas.width = PIXEL_GRID_SIZE; canvas.height = PIXEL_GRID_SIZE; const ctx = canvas.getContext('2d'); actor.costume.data.forEach((color, index) => { if (color && color !== 'transparent') { const x = index % PIXEL_GRID_SIZE; const y = Math.floor(index / PIXEL_GRID_SIZE); ctx.fillStyle = color; ctx.fillRect(x, y, 1, 1); } }); actor.element.style.backgroundImage = `url(${canvas.toDataURL()})`; actor.element.style.backgroundColor = 'transparent'; }
        
        // --- LÓGICA DO EDITOR DE CENÁRIO ---
        function createDefaultBackground() { return { type: 'pixel', data: Array(SCENERY_GRID_WIDTH * SCENERY_GRID_HEIGHT).fill('transparent') }; }
        function renderStageBackground() { if (!stageBackground || stageBackground.type !== 'pixel') { stage.style.backgroundImage = 'none'; stage.style.backgroundColor = '#f7f7f7'; return; } const canvas = document.createElement('canvas'); canvas.width = SCENERY_GRID_WIDTH; canvas.height = SCENERY_GRID_HEIGHT; const ctx = canvas.getContext('2d'); stageBackground.data.forEach((color, index) => { if (color && color !== 'transparent') { const x = index % SCENERY_GRID_WIDTH; const y = Math.floor(index / SCENERY_GRID_WIDTH); ctx.fillStyle = color; ctx.fillRect(x, y, 1, 1); } }); stage.style.backgroundImage = `url(${canvas.toDataURL()})`; stage.style.backgroundColor = 'transparent'; }
        function openSceneryEditor() {
            sceneryGrid.innerHTML = '';
            const sceneryData = stageBackground.data;
            for (let i = 0; i < SCENERY_GRID_WIDTH * SCENERY_GRID_HEIGHT; i++) {
                const pixel = document.createElement('div');
                pixel.className = 'scenery-pixel';
                const color = sceneryData[i];
                pixel.style.backgroundColor = (color === 'transparent' || !color) ? '' : color;
                if(color === 'transparent' || !color) pixel.classList.add('eraser');
                sceneryGrid.appendChild(pixel);
            }
            sceneryEditorModal.style.display = 'flex';
        }
        function closeSceneryEditor() { sceneryEditorModal.style.display = 'none'; }
        function paintSceneryPixel(pixelElement) {
            pixelElement.classList.remove('eraser');
            if (activeColor === 'transparent') {
                pixelElement.style.backgroundColor = '';
                pixelElement.classList.add('eraser');
            } else {
                pixelElement.style.backgroundColor = activeColor;
            }
        }
        function clearSceneryGrid() {
            document.querySelectorAll('#scenery-grid .scenery-pixel').forEach(pixel => {
                pixel.style.backgroundColor = '';
                pixel.classList.add('eraser');
            });
        }
        function fillSceneryGrid() {
            if (!confirm(`Tem certeza que deseja preencher todo o cenário com a cor selecionada? Esta ação substituirá o desenho atual.`)) {
                return;
            }
            const pixels = document.querySelectorAll('#scenery-grid .scenery-pixel');
            pixels.forEach(pixel => {
                paintSceneryPixel(pixel);
            });
        }
        function saveScenery() {
            const newData = [];
            document.querySelectorAll('#scenery-grid .scenery-pixel').forEach(pixel => {
                const color = pixel.style.backgroundColor;
                newData.push(color ? color : 'transparent');
            });
            stageBackground.data = newData;
            renderStageBackground();
            closeSceneryEditor();
        }

        // --- LÓGICA DO EDITOR DE ATOR ---
        function initializePixelEditor() {
            [colorPaletteContainer, sceneryColorPaletteContainer].forEach(palette => {
                palette.innerHTML = '';
                paletteColors.forEach(color => {
                    const colorBox = document.createElement('div');
                    colorBox.className = 'color-box';
                    if (color === 'transparent') colorBox.classList.add('eraser');
                    else colorBox.style.backgroundColor = color;
                    colorBox.dataset.color = color;
                    colorBox.onclick = () => selectColor(color);
                    palette.appendChild(colorBox);
                });
            });
            selectColor(activeColor);

            pixelGrid.addEventListener('mousedown', (e) => { isDrawingPixels = true; if (e.target.classList.contains('pixel')) paintPixel(e.target); e.preventDefault(); });
            pixelGrid.addEventListener('mouseover', (e) => { if (isDrawingPixels && e.target.classList.contains('pixel')) paintPixel(e.target); });
            sceneryGrid.addEventListener('mousedown', (e) => { isDrawingPixels = true; if (e.target.classList.contains('scenery-pixel')) paintSceneryPixel(e.target); e.preventDefault(); });
            sceneryGrid.addEventListener('mouseover', (e) => { if (isDrawingPixels && e.target.classList.contains('scenery-pixel')) paintSceneryPixel(e.target); });

            document.addEventListener('mouseup', () => { isDrawingPixels = false; });
            document.addEventListener('mouseleave', () => { isDrawingPixels = false; });
        }
        function openPixelEditor() {
            const actor = getSelectedActor();
            if (!actor) { alert("Por favor, selecione um ator para desenhar."); return; }
            pixelGrid.innerHTML = '';
            const costumeData = actor.costume.data;
            for (let i = 0; i < PIXEL_GRID_SIZE * PIXEL_GRID_SIZE; i++) {
                const pixel = document.createElement('div');
                pixel.className = 'pixel';
                const color = costumeData[i];
                pixel.style.backgroundColor = (color === 'transparent' || !color) ? '' : color;
                if(color === 'transparent' || !color) pixel.classList.add('eraser');
                pixelGrid.appendChild(pixel);
            }
            updatePixelPreview();
            pixelEditorModal.style.display = 'flex';
        }
        function closePixelEditor() { pixelEditorModal.style.display = 'none'; }
        function selectColor(color) {
            activeColor = color;
            document.querySelectorAll('.color-box').forEach(box => {
                if (box.dataset.color === color) box.classList.add('active');
                else box.classList.remove('active');
            });
        }
        function paintPixel(pixelElement) {
            pixelElement.classList.remove('eraser', 'pop');
            if (activeColor === 'transparent') {
                pixelElement.style.backgroundColor = '';
                pixelElement.classList.add('eraser');
            } else {
                pixelElement.style.backgroundColor = activeColor;
            }
            void pixelElement.offsetWidth; // Trigger reflow to restart animation
            pixelElement.classList.add('pop');
            updatePixelPreview();
        }
        function clearPixelGrid() {
            document.querySelectorAll('#pixel-grid .pixel').forEach(pixel => {
                pixel.style.backgroundColor = '';
                pixel.classList.add('eraser');
                pixel.classList.remove('pop');
            });
            updatePixelPreview();
        }
        function updatePixelPreview() {
            const ctx = previewCanvas.getContext('2d');
            ctx.clearRect(0, 0, PIXEL_GRID_SIZE, PIXEL_GRID_SIZE);
            const pixels = document.querySelectorAll('#pixel-grid .pixel');
            pixels.forEach((pixel, index) => {
                const color = pixel.style.backgroundColor;
                if (color) {
                    const x = index % PIXEL_GRID_SIZE;
                    const y = Math.floor(index / PIXEL_GRID_SIZE);
                    ctx.fillStyle = color;
                    ctx.fillRect(x, y, 1, 1);
                }
            });
        }
        function savePixelArt() {
            const actor = getSelectedActor();
            if (!actor) return;
            const newData = [];
            document.querySelectorAll('#pixel-grid .pixel').forEach(pixel => {
                const color = pixel.style.backgroundColor;
                newData.push(color ? color : 'transparent');
            });
            actor.costume.data = newData;
            renderActorCostume(actor);
            closePixelEditor();
        }

        // --- LÓGICA DE INICIALIZAÇÃO ---
        function initializeApp() {
            stageBackground = createDefaultBackground();
            initializePixelEditor();
            renderStageBackground();
        }
        function toggleExecution() {
             isRunning=!isRunning;
             const b=document.getElementById('btn-run');
             if(isRunning){
                 actors.forEach(a => { a.isStopped = false; }); 
                 renderAllVariableDisplaysOnStage();
                 b.textContent="Parar";b.classList.add('stop');
                 actors.forEach(a => { a.scripts.filter(s => s.trigger.type === 'ON_START').forEach(s => executeScript(a,s)) });
                 gameLoop();
             } else {
                 b.textContent="Executar";b.classList.remove('stop');
                 cancelAnimationFrame(animationFrameId);
             }
        }
        function gameLoop() { if(!isRunning)return; actors.forEach(a=>{a.scripts.filter(s=>s.trigger.type==='FOREVER').forEach(s=>executeScript(a,s))}); animationFrameId=requestAnimationFrame(gameLoop); }
        window.addEventListener('keydown', (e) => { if(isRunning) actors.forEach(a => { a.scripts.filter(s => s.trigger.type === 'ON_KEY' && s.trigger.params.key && s.trigger.params.key.content.toLowerCase() === e.key.toLowerCase()).forEach(s => executeScript(a, s)); }); });
        window.addEventListener('click', (event) => { if (paramMenu && !paramMenu.contains(event.target) && activeInputContext) hideParamMenu(); });
        
        // --- INICIALIZAR EDITOR ---
        initializeApp();
    </script>
</body>
</html>